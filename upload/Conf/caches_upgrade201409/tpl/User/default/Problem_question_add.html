<include file="Public:head" />
<link rel="stylesheet" type="text/css" href="{pigcms::RES}/css/cymain.css" />
<link href="{pigcms::RES}/css/activity.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/tpl/User/default/common/js/date/WdatePicker.js"></script>
<script src="/tpl/static/artDialog/jquery.artDialog.js?skin=default"></script>
<script src="/tpl/static/artDialog/plugins/iframeTools.js"></script>
<div class="content">
<div class="cLineB">
<h4 class="left">题目设置</h4>
  <a href="{pigcms::U('Problem/question',array('token'=>$token,'problem_id'=>$problem_id))}" class="right  btnGreen">返回</a>
<div class="clr"></div>
</div>
<style>
  div.activity{margin: 0px}
  .topic_box{border-top: 0px;}

.question_box ul a.list_del {float:none;}
</style>
<div class="indexout">
<div class="new_pub">
      <div class="activity">
        <form id="survey_form" method="post">  
            <div class="topic_box">
                    <div class="question_box" id="question_info_1">
                    <p class="question_info">
                        <span>问题<u>1</u>：</span>
                        <input type="text" class="txt" name="question[0]" value="请填写问题的题目">
                        <input type="hidden" class="hide_qid" name="qid[0]" id="qid[0]">
                        <!--<input type="checkbox" class="checkd" name="ismulti[1]" id="ismulti_1" value="1"><label for="ismulti_1"> 允许多选</label>-->
                        <input type="text" class="sort" name="sort[0]" value="50" style="border:1px solid #ccc;width:30px;">排序
                        <input type="checkbox" class="px" name="is_show[0]" id="ismulti_1" value="1" checked>显示
                    </p>
                    <ul id="0" class="optionul">
                        <li>
                            <span>A</span><u>选项：</u>
                            <input type="hidden" class="hide_txt" name="oid[0][0]">
                            <input type="text" class="txt" name="option[0][0]">
                            <input type="checkbox" class="checkd" name="is_true[0][0]" id="is_true_0" value="1">答案
                            <a class="list_del" href="javascript:;" title="删除这个选项">×</a>
                        </li>
                        <li>
                            <span>B</span><u>选项：</u>
                            <input type="hidden" class="hide_txt" name="oid[0][1]">
                            <input type="text" class="txt" name="option[0][1]">
                            <input type="checkbox" class="checkd" name="is_true[0][1]" id="ismulti_1" value="1">答案
                            <a class="list_del" href="javascript:;" title="删除这个选项">×</a>
                        </li>
                        <li>
                            <span>C</span><u>选项：</u>
                            <input type="hidden" class="hide_txt" name="oid[0][2]">
                            <input type="text" class="txt" name="option[0][2]">
                            <input type="checkbox" class="checkd" name="is_true[0][2]" id="ismulti_1" value="1">答案
                            <a class="list_del" href="javascript:;" title="删除这个选项">×</a>
                        </li>
                     </ul>
                <p class="bot_add"><a href="javascript:;" class="btnGrayS vm bigbtn"><img src="{pigcms::RES}/images/product/add.png" width="16" class="vm">再添加一个选项</a></p>
                </div>
                <p class="add_questio"><a href="javascript:;" title="添加" class="btnGrayS vm bigbtn"><img src="{pigcms::RES}/images/product/add.png" width="16" class="vm">再添加一题</a></p>
            </div>
           
            <ul>            
    <ul class="pub_list">
    <li class="bot">
         <input class="btnGreen" type="button" id="submit_survey" value="保存"> &nbsp;
         <a href="{pigcms::U('Research/index',array('token'=>$token))}" class="btnGray vm">取消</a>
        </li>
    </ul>
</ul>     
</form>
</div>
</div>
</div>

</div>
<script type="text/javascript">
$(document).ready(function(e) {
  dateformat('starttime', 0);
  dateformat('deadline', 7);
  number();
    $("#submit_survey").click(function(){
      var flag = true;
      var info = '';

      $('.question_box').each(function(){

        //alert($(this).find('.question_info>.txt').length);
        var input = $(this).find('.question_info>.txt');
            if(input.val() == '' || input.val() == '请填写问题的题目'){
              flag = false;
              info += '请填写完整的题目信息\n';
            }else{
              var option = input.parent('.question_info').siblings('.optionul').find('li .txt');
              var is_true = input.parent('.question_info').siblings('.optionul').find('.checkd');
              var op_flag = false;
              var is_flag = false;
              for (var i = option.length - 1; i >= 0; i--) {
                  if(option[i].value != ''){
                    op_flag = true;
                  }

                  if(is_true[i].checked === true){
                    is_flag = true;
                  }
              };    
                  if(!op_flag){
                    info += '每个问题请至少设置一个答案选项\n';
                  }
                  if(!is_flag){
                    info += '每个题目请至少设置一个正确的答案\n';
                  }
              
            }
      });
          if(info.length > 0){
            alert(info);
          }else{
            $("form:first").submit(); 
          }

    });
    
    $(".del").live("click",function(){
      delimage($(this));    
    });
    
    $(".optionul li .pic").live('mouseenter',function(){
      $(this).children("img").show();
    });
    
    $(".optionul li .pic").live('mouseleave',function(){
      $(this).children("img").hide();
    });


    checked();
});
function checked(){
      $(".optionul li").find('.checkd').each(function(){
      $(this).click(function(){
        if($(this).attr('checked') === true){
          $(this).parent().siblings('li').children('input:checkbox').attr('checked','');
        }
      });
    });
}
function delimage(obj){
  obj.parent().addClass("hidden");
  obj.parent().prev("span").removeClass("hidden");
  //obj.parent().parent().find("input[class='image_class']").val("");
}


function clear_form()
{
  $("input").val(''); 
  $("textarea").val(''); 
  $("select").val('');
  $("#infotype").val(3);
    $("#tag_image_show").hide();
    $("#explanation").hide();
}

/*添加选项*/
function number(){
  var i = 0;
    $(".optionul li").each(function(){
        $(this).find("input[name='userfile']").attr("id","userfile_" + i).live("change",function(){
          uploadimage($(this).attr("id"));
        });
        i ++;
    })  
}
$("#userfile").change(function(){ 
  upload_image();            
});
function upload_cancel()
{
 $('#tag_image_show').hide();
     $("#cover_image").val('');
     $("#file_name").val('');
     $("#show_name").html('');
     $("#tag_image_src").attr('src', '').hide();
     $("#file_partpath").val('');
}

$(".orange_tips a.close").click(function(){
    $(".orange_tips").remove();
})

/*添加选项*/
var a = new Array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z");
function letters(){
    $(".question_box ul li").each(function(){
        $(this).find("span:first").html(a[$(this).index()]);  
        $(this).find(".txt").attr('name', 'option['+$(this).parent().attr('id')+']['+$(this).index()+']');
        $(this).find(".hide_txt").attr('name', 'oid['+$(this).parent().attr('id')+']['+$(this).index()+']');
        $(this).find(".image_class").attr('name', 'image['+$(this).parent().attr('id')+']['+$(this).index()+']');
        $(this).find(".checkd").attr('name', 'is_true['+$(this).parent().attr('id')+']['+$(this).index()+']');
        $(this).find(".checkd").attr('name', 'is_true['+$(this).parent().attr('id')+']['+$(this).index()+']');
    }); 
    $(".topic_box .question_box").each(function(){
        $(this).find(".question_info span u").html($(this).index() + 1);
    }); 
    $('#question_info_1 .box_del').remove();
    $('.question_box ul li .txt').focus(function(){
        $(this).next().show();
    });
    checked();
}

letters();

$(".question_box ul li .list_del").live('click',function(){                        
  $(this).parents("li").remove();
  letters();
});  

    
$(".question_box .bot_add a.btnGrayS").live('click',function(){
    var t = '<li><span>A</span><u>选项：</u><input type="hidden" class="hide_txt"> <input type="text" class="txt"/><input type="hidden" class="image_class" /><input type="checkbox" class="checkd" name="is_true[1][2]" id="ismulti_1" value="1">答案<a class="list_del" href="javascript:;" title="删除这个选项">×</a></li>';
    if($(this).parents(".question_box").find("ul li").size() <= 25){
        $(this).parents(".question_box").find("ul").append(t);
        letters();
        number();
    }else{
        alert("您添加的数量够用了！");
    }
});
/*添加选项结束*/

/*添加题目和删除题目*/
$(".add_questio a").click(function(){
    var t = '<div class="question_box"><p class="question_info"><span>问题<u>1</u>：</span><input type="text" class="txt" value="请填写问题的题目" /><input type="text" class="sort" value="50" style="border:1px solid #ccc;width:30px;">排序&nbsp;<input type="checkbox" class="px is_show id="ismulti_1" value="1" checked>显示'
           +'</p>'
           +'<span class="insert_pic hidden">图片建议尺寸：150*100</span><ul id="1" class="optionul"><li><span>A</span><u>选项：</u><input type="hidden" class="hide_txt"> <input type="text" class="txt" /><input type="checkbox" class="checkd" value="1">答案<a class="list_del" href="javascript:;" title="删除这个选项">×</a></li>'
           +'<li><span>B</span><u>选项：</u><input type="hidden" class="hide_txt" > <input type="text" class="txt" /><input type="checkbox" class="checkd" value="1">答案<a class="list_del" href="javascript:;" title="删除这个选项">×</a></li>'
           +'<li><span>C</span><u>选项：</u><input type="hidden" class="hide_txt" > <input type="text" class="txt" /><input type="checkbox" class="checkd" value="1">答案<a class="list_del" href="javascript:;" title="删除这个选项">×</a></li>'
           +'</ul><p class="bot_add"><a href="javascript:;" class="btnGrayS vm bigbtn"><img src="{pigcms::RES}/images/product/add.png" width="16" class="vm">再添加一个选项</a></p></div>';
    $(".add_questio").before(t);
    $(".question_box:last").find("li:eq(2)").nextAll().remove();
    $(".question_box").each(function() {
        //$(this).find("u").html($(this).index());
        $(this).find(".question_info .txt").attr('name', 'question['+$(this).index()+']');
        $(this).find(".question_info .sort").attr('name', 'sort['+$(this).index()+']');
        $(this).find(".question_info .is_show").attr('name', 'is_show['+$(this).index()+']');
        $(this).find(".question_info .checkd").attr('name', 'ismulti['+$(this).index()+']');
        $(this).find(".question_info .checkd").attr('id', 'ismulti_'+$(this).index());
        $(this).find(".question_info label").attr('for', 'ismulti_'+$(this).index());
        $(this).find(".question_info .hide_qid").attr('name', 'qid['+$(this).index()+']');
        $(this).find("ul").attr('id', $(this).index());
    }); 
    letters();
    number();
})
$(".box_del").live('click',function(){
    $(this).parents(".question_box").remove();
    $(".question_box").each(function() {
        //$(this).find("u").html($(this).index());
    }); 
    letters();
    number();
})
/*添加题目和删除题目结束*/


$(".question_box p .txt").live('focusin',function(){
    if($(this).val() == "请填写问题的题目"){
        $(this).val("");
    $(this).css("color","#666");
    }
}).live('focusout',function(){
    if($(this).val() == ""){
        $(this).val("请填写问题的题目");
    $(this).css("color","#999");
    }
});


function dateformat(id, day){
 var date = new Date();
 date.setDate(date.getDate()+day);
 var deadline = date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate()+' '+date.getHours()+':'+date.getMinutes()+':'+date.getSeconds();
 $("#" + id).val(deadline);
}
</script>
<include file="Public:footer"/>